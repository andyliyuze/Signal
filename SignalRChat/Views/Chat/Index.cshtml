@{
    ViewBag.Title = "Login";
    Layout = null;
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="~/Scripts/bootstrap.min.css" rel="stylesheet" />

    <link href="~/Css/Chat.css" rel="stylesheet" />

    <link href="~/Css/group.css" rel="stylesheet" />
     <script src="/Scripts/jquery-2.0.0.min.js"></script>
    <script src="/Scripts/bootstrap.min.js"></script>

    <script src="/Scripts/avartar/jquery.cropit.js"></script>

    <script src="/Scripts/chat/status.js"></script>
    <script src="/Scripts/chat/common.js"></script>
    <script src="/Scripts/chat/chatHelper.js"></script>
    <script src="/Scripts/chat/userHelper.js"></script>
    <script src="/Scripts/chat/chatclient.js"></script>
    <script src="/Scripts/chat/userclient.js"></script>

    <script src="/Scripts/chat/groupHelper.js"></script>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <!--Reference the SignalR library. -->
    <script src="../Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/js"></script>
    <style>
        .cropit-preview {
            background-color: #f8f8f8;
            background-size: cover;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-top: 7px;
            width: 250px;
            height: 250px;
        }

        .cropit-preview-image-container {
            cursor: move;
        }

        .image-size-label {
            margin-top: 10px;
        }

        input, .export {
            display: block;
        }

        button {
            margin-top: 10px;
        }
    </style>

    <script type="text/javascript">

        var chatHub;
        var userHub ;
        $(function () {
            $.connection.hub.logging = true;
            chatHub  = $.connection.chatHub;
            userHub = $.connection.userHub;
            setScreen(false);

            //      Declare a proxy to reference the hub.

            registerClientMethodsForChat(chatHub);
            registerClientMethodsForUser(userHub);
            // Start Hub
            $.connection.hub.start().done(function () {
                registerEvents(chatHub, userHub);
                console.log("连接完成");
 
            });
            $.connection.hub.disconnected(function () {
            
                console.log("正在尝试重新连接");
                setTimeout(function () {
                    $.connection.hub.start().done(function () {
                        console.log("连接完成");
                     //   registerEvents(chatHub, userHub);
                    });
                }, 5000); // Restart connection after 5 seconds.
            });
        });

        function setScreen(isLogin) {
            if (!isLogin) {
                $("#divChat").hide();
                $("#divLogin").show();
            }
            else {
                $("#divChat").show();
                $("#divLogin").hide();
            }
        }


        function registerEvents(chatHub, userHub) {





            $("#txtNickName").keypress(function (e) {
                if (e.which == 13) {
                    $("#btnStartChat").click();
                }
            });
            //在编辑文本框时候按下enter键，表示发送消息
            $("#txtPrivateMessage").keypress(function (e) {
                if (e.which == 13) {
                    if ($('.btn_send').hasClass("single")) { $(".btn_send.single").click(); }
                    if ($('.btn_send').hasClass("group")) { $(".btn_send.group").click(); }
                    else { return;}
                }
            });
            // Send Button event
            //私信消息
            $(document).on("click", ".btn_send.single", function () {
           // $(".btn_send.single").click(function () {
                var message = CreateMesModel();

                if (message.content.length > 0)
                {
                    SendMsgHandlerForView(message);
                    //将消息发送到后台处理
                    chatHub.server.sendPrivateMessage(message);


                }
                else { alert("不能发送空消息"); return; }
            });

            //群发消息
        //    $(".btn_send group").click(function () {
                $(document).on("click", ".btn_send.group", function () {
                var message=  CreateMesModel();
                if (message.content.length > 0)
                {
                    SendMsgHandlerForView(message);
                    //将消息发送到后台处理
                    chatHub.server.sendGroupMessage(message);
                }
                else { alert("不能发送空消息"); return; }
            });


            //点击查看好友申请的item
            $(document).on('click', '.apply_ul_item', function (e) {
                var Applys = GetSeesionStorageList("FriendsApplys");
                var GroupApplys = GetSeesionStorageList("GroupApplys");
                $(".list-group.friendsApply li").remove();
                $(".list-group.groupApply li").remove();
                if ($("#friendsapplyModal").length <= 0) {

                    $("#modal").load("/User/_FriensApplysPage", function (response, status, xhr) {
                        bindingApplys(Applys);
                        bindingGroupApplys(GroupApplys);
                        $("#friendsapplyModal").modal('show');
                    });
                }
                else {
                    bindingApplys(Applys);
                    bindingGroupApplys(GroupApplys);
                    $("#friendsapplyModal").modal('show');

                }


            });

            //点击查看添加好友回复
            $(document).on('click', '.reply_ul_item', function (e) {

                var FriendReplys = GetSeesionStorageList("FriendReplys");
                var GroupReplys = GetSeesionStorageList("GroupReplys");
                //去除好点标识
                $(this).find("i.icon").removeClass("web_wechat_reddot");
                $(".list-group.friendsReply li").remove();
                $(".list-group.groupReply li").remove();
                if ($("#friendsreplyModal").length <= 0)
                {
                    //此步骤是异步操作，因此必须等待异步完成后才能更改Stroage以及数据库
                    $("#modal").load("/User/_ReplyResultPage", function (response, status, xhr) {

                        bindingReplys(FriendReplys);

                        bindingGroupReplys(GroupReplys)
                        ShowReplyModalBeforeCheck(FriendReplys.length, GroupReplys.length);
                        $("#friendsreplyModal").modal('show');
                        //更新Stroage以及数据库中未读消息
                        UpdateUnreadFriendsApply(FriendReplys);
                        UpdateUnreadGroupApply(GroupReplys);
                    });
                }
                else {

                    bindingReplys(FriendReplys);
                    bindingGroupReplys(GroupReplys);
                    ShowReplyModalBeforeCheck(FriendReplys.length, GroupReplys.length);
                    $("#friendsreplyModal").modal('show');
                    //更新Stroage以及数据库中未读消息
                    UpdateUnreadFriendsApply(FriendReplys);
                    UpdateUnreadGroupApply(GroupReplys);
                }

            });

            //点击用户时绑定用户名和id
            $(document).on('click', '.friends_item', function () {
                if (IsCurrentUserOrNotUser(this)) { return; }
                //获取当前用户用户名
                var username = $(this).find(".nickname_text").text();
                //更改聊天窗口的用户名
                $("#currentUserName").text(username);
                //获取当前聊天用户的Id
                var id = $(this).attr("data-uid");
                //更改聊天窗口的用户Id
                $("#currentUserName").attr("data-uid", id);
                //清空聊天对话框的消息
                $(".message_ul .message_item ").remove();
                if ($(this).hasClass("NeedGetMsgFromBack")) {
                    //清楚需要从后台获取数据的标识
                    $(this).removeClass("NeedGetMsgFromBack");
                    //
                    var MsgId = $(this).attr("data-unreadMsgId");
                    //如果存在未读消息，则从去后台获取未读消息数据
                    var unreadcount = $(this).attr("data-unreadcount");
                    //  unreadcount = getNum(unreadcount);
                    if (unreadcount > 0) {
                        chatHub.server.getUnreadMsg(id, MsgId, unreadcount).done(function () {
                            //将浏览器的本地缓存消息加载到聊天窗口中
                            GetStrogeMessage(id);

                        });
                    }
                }
                else {
                    //将浏览器的本地缓存消息加载到聊天窗口中
                    GetStrogeMessage(id);
                }




                //让未读标志的红点消失
                $(this).find("i.icon").removeClass("web_wechat_reddot");
                //让未读条数变为0，前端
                $("#ul_item_" + id + "").find(".chat_item_info p.msg span.unreadcount").remove();
                //让发送消息按钮标记为单人消息
                $(".btn_send").removeClass("group").addClass("single");

            });
            //点击+号弹出搜索弹框
            $("#AddUser").click(function () {

                if ($("#myModal").length <= 0) {
                    $("#modal").load("/User/_SearchUserPage", function (response, status, xhr) {
                        $("#myModal").modal('show');

                    });
                }
                else {

                    $("#myModal").modal('show');
                }

                $(".searchresult_info").hide();
                $("#searchVal").val("");
            });
            //searchBtn
            $(document).on('click', "#searchBtn", function () {
                var name = $("#searchVal").val();
                var type = $(".search_type").attr("data-type");
                userHub.server.searchUser(name,type);
            });
            //发送申请，群或者好友
            $(document).on('click', "#sendreply", function () {
                //确定申请的类型，好友还是群
                var type = $("#searchresult_uid").attr("data-type");
                var applyUid = $("#hdUserName").attr("data-uid");
                //被申请的主键Id，可能是群Id或者好友Id
                var recevieUid = $("#searchresult_uid").val();
               if (type == "User") {
                   if (applyUid == recevieUid) { alert("不能添加自己为好友!"); return; }
                   userHub.server.sendAddFriendsReply(applyUid, recevieUid);
               }
               else
               {

                   userHub.server.sendAdGroupReply(applyUid, recevieUid);
               }
            });

            //通过申请按钮
            $(document).on('click', '.reply-pass.friend', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
                //更新一下自己的好友列表
                AddUser(ReplyModel.ApplyUid, ReplyModel.ReplyName, ReplyModel.Avatar, ReplyModel.IsOnline);
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已同意", "FriendsApplys", "FriendsApplyId");

                //先修改一下样式
                $(this).parent().css("padding-top", "10px");
                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已同意");
               $(this).parent().find("button").remove();
                //更新一下数据库
                userHub.server.beFriend(ReplyModel.ReceiverUserId, ReplyModel.ApplyUid, ReplyModel.ApplyId);
            });
            //拒绝好友申请
            $(document).on('click', '.reply-refuse.friend', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已拒绝", "FriendsApplys");
                //先修改一下样式
                $(this).parent().css("padding-top", "10px");

                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已拒绝");

                $(this).parent().find("button").remove();
                //更新一下数据库
                userHub.server.refuseApply(ReplyModel.ReceiverUserId, ReplyModel.ApplyId, ReplyModel.ApplyId);
            });

            //通过入群申请按钮
            $(document).on('click', '.reply-pass.group', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);

                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已同意", "GroupApplys", "GroupApplyId");

                //先修改一下样式
               $(this).parent().css("padding-top", "10px");

                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已同意");

                $(this).parent().find("button").remove();
                //更新一下数据库,此时ReceiverUserId代表组Id
                userHub.server.beGroupMember(ReplyModel.ReceiverUserId, ReplyModel.ApplyUid, ReplyModel.ApplyId);
            });

            //拒绝入群申请
            $(document).on('click', '.reply-refuse.group', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已拒绝", "GroupApplys", "GroupApplyId");

                //先修改一下样式
                $(this).parent().css("padding-top", "10px");
                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已拒绝");

                $(this).parent().find("button").remove();
                //更新一下数据库
                userHub.server.refuseGroupApply(ReplyModel.ReceiverUserId, ReplyModel.ApplyId, ReplyModel.ApplyId);
            });



            //tab切换
            $(".tab .tab_item").click(function () {
                $(".pannel .item").addClass("hide");
                var type = $(this).attr("data-type");
                $(".tab .tab_item .web_wechat_tab_chat").css("background-position", "0 -2049px");
                $(".tab .tab_item .web_wechat_tab_public").css("background-position", "0 -2232px");
                $(".tab .tab_item .web_wechat_tab_friends").css("background-position", "0 -2140px");
                if (type == "chat") {
                    $(".pannel .item.chat_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_chat").css("background-position", "0 -2085px");
                    return;
                }
                if (type == "friends") {
                    $(".pannel .item.friends_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_public").css("background-position", "0 -2267px");
                    return;
                }
                if (type == "gruops") {
                    $(".pannel .item.groups_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_friends").css("background-position", "0 -2175px");
                    return;
                }
            });

            $(document).on('click', "#ul_item_createGroup", function () {
                $("#modal").load("/Group/_CreateGroupPage", function (response, status, xhr) {
                    $("#CreateGroupModal").modal('show');
                    $('.image-editor').cropit();
                    $('.export').click(function () {
                        var imageData = $('.image-editor').cropit('export');
                        $("#img-data").val(data);
                    });
                });
            });

            $(document).on('click', "#createGroup", function () {
                var groupname=$("#setgroupName").val();
                var imageData = $('.image-editor').cropit('export');
                var uid = $("#hdUserName").attr("data-uid");
                imageData = imageData.replace("data:image/png;base64,", "");
                $.ajax({
                    type: 'post',
                    url: '/Group/CreateGruop',
                    data: { GroupName: groupname, Avatar: imageData, UserId: uid },
                    success: function (data) {
                        if (data.result == true) {
                            alert("创建成功");
                            AddGroup(data.groupId, data.groupName, data.groupAvatar);
                            $("#CreateGroupModal").modal('hide');
                        }
                        else {
                            alert("创建失败");
                        }
                    },
                    error: function () { alert("系统出错"); }
                })
            });

            $(document).on('click', ".dropdown-menu.search_type_ul li a", function ()
            {
                var arr = $(".search_type").html().split('<span class="caret"></span>');
                var text = arr[0];
                text = $(this).text();
                $(".search_type").attr("data-type", text);
                $(".search_type").html(text+"<span class=caret></span>");
            });

            //点击群列表

            //点击用户时绑定用户名和id
            $(document).on('click', '.group_item', function () {
                if (IsCurrentGroupOrNotUser(this)) { return; }
                //获取当前用户用户名
                var username = $(this).find(".nickname_text").text();
                //更改聊天窗口的用户名
                $("#currentUserName").text(username);
                //获取当前聊天用户的Id
                var id = $(this).attr("data-uid");
                //更改聊天窗口的用户Id
                $("#currentUserName").attr("data-uid", id);
                //清空聊天对话框的消息
                $(".message_ul .message_item ").remove();
                if ($(this).hasClass("NeedGetMsgFromBack")) {
                    //清除需要从后台获取数据的标识
                    $(this).removeClass("NeedGetMsgFromBack");
                    //
                    var MsgId = $(this).attr("data-unreadMsgId");
                    //如果存在未读消息，则从去后台获取未读消息数据
                    var unreadcount = $(this).attr("data-unreadcount");
                    //  unreadcount = getNum(unreadcount);
                    if (unreadcount > 0) {
                        chatHub.server.getUnreadMsg(id, MsgId, unreadcount).done(function () {
                            //将浏览器的本地缓存消息加载到聊天窗口中
                            GetStrogeMessage(id);

                        });
                    }
                }
                else {
                    //将浏览器的本地缓存消息加载到聊天窗口中
                    GetStrogeMessage(id);
                }




                //让未读标志的红点消失
                $(this).find("i.icon").removeClass("web_wechat_reddot");
                //让未读条数变为0，前端
                $("#ul_item_" + id + "").find(".chat_item_info p.msg span.unreadcount").remove();

                //让发送消息按钮标记为群发消息
                $(".btn_send").removeClass("single").addClass("group");
            });








            //监听模态框关闭事件
            $(document).on('.modal', 'hide.bs.modal', function () {
                // 执行一些动作...
                $("#modal").children().remove();
            })
            //清除


            $(".web_wechat_add").click(function () {
                if ($("#mmpop_system_menu").css("display") == "none") {
                    $("#mmpop_system_menu").fadeIn();
                }
                else {

                    $("#mmpop_system_menu").fadeOut();
                }
            });
        }

    </script>


    <script>

        $(function () {
            sessionStorage.clear();
        });
    </script>


</head>
<body>
    <div class="main" id="divChat">

        <div class="pannel">
            <div class="header" style="position: relative; height: 76px; width: 100%;">
                <div class="avatar">

                    <img id="myheadsrc" style="width: 100%;" src="/Images/webwxgeticon.jpg" data-uid="" />
                </div>

                <div class="info">
                    <span style="color: #fff;" data-uid="" id="hdUserName"></span>
                    <a style="margin-left: 100px;">
                        <i class="web_wechat_add"></i>
                   
                    </a>
                </div>
            </div>
            <div class="search_bar">
                <i class="web_wechat_search"></i>
                <input class="frm_search ng-isolate-scope ng-pristine ng-valid" type="text" placeholder="搜索">
            </div>
            <div class="tab">
                <div class="tab_item" data-type="chat">
                    <a class="chat" title="聊天" href="#">
                        <i class="web_wechat_tab_chat web_wechat_tab_chat_hl"></i>
                    </a>
                </div>
                <div class="tab_item " data-type="friends">
                    <a class="chat" title="阅读" href="#">
                        <i class="web_wechat_tab_public"></i>
                    </a>
                </div>
                <div class="tab_item" data-type="gruops">
                    <a class="chat" title="通讯录" href="#">
                        <i class="web_wechat_tab_friends"></i>
                    </a>
                </div>
            </div>
            <div class="item chat_ul">
                <div class="chat_ul_div">



                </div>
            </div>
            <div class="item friends_ul hide">

            </div>
            <div class="item groups_ul hide">
                <div class="chat_ul_div">

                    <div data-uid="a401ff37-857f-4816-b981-b91419f37726" class="chat_ul_item" id="ul_item_createGroup">

                        <div class="avatar">
                            <img class="img" id="img_a401ff37-857f-4816-b981-b91419f37726" src="/Content/upload/image/HeadImage/20170210172536.Jpeg">
                            <i class="icon ng-scope"></i>
                        </div>
                        <div class="chat_item_info">
                            <h3 class="nickname">
                                <span class="nickname_text ng-binding" style="margin-top: 10px;  font-size: 15px; color: #56b5ad;">创建群</span>
                            </h3>
                        </div>
                    </div>

                </div>
            </div>

            <div id="mmpop_system_menu" class="mmpop ng-scope system_menu" tabindex="-1" style="top: 60px; left: 85px;display:none">
                <ul class="dropdown_menu">
                    <li>
                        <a tabindex="-1" href="javascript:;"   title="添加">
                            <i class="web_wechat_addUser" id="AddUser"></i>添加
                        </a>
                    </li>
                    
                    <li>
                        <!-- ngIf: !isSoundOpen -->
                        <!-- ngIf: isSoundOpen --><a tabindex="-1" href="javascript:;"  title="关闭声音" class="ng-scope">
                            <i class="menuicon_volume_on"></i>关闭声音
                        </a><!-- end ngIf: isSoundOpen -->
                    </li>
                   
                    <li class="last_child">
                        <a tabindex="-1" href="javascript:;"  title="退出">
                            <i class="menuicon_quit"></i>退出
                        </a>
                    </li>
                </ul>

            </div>





        </div>
        <div class="right chat">
            <div class="panel panel-default" style="background-color: #eee;">
                <div id="currentUserName" data-uid="" class="panel-heading" style="text-align: center;">
                    Panel heading without title
                    <i class="web_wechat_down_icon"></i>
                </div>
                <div class="panel-body" style="padding-bottom: 0; height: 377px; overflow: auto;">
                    <div class="ng-scope">
                        <div class="message_ul">
                            <div class="message_item message" style="margin-bottom :16px; float:left; width:100%;">
                                <p class="message_system ng-scope">
                                    <span class="content ng-binding">9:52</span>
                                </p>

                                <img class="avatar" src="/Images/webwxgeticon%20(1).jpg" title="李思晓" />
                                <div class="content">

                                    <div class="bubble js_message_bubble ng-scope bubble_default left">
                                        <div class="bubble_cont ng-scope">
                                            <div class="plain">
                                                <pre class="js_message_plain ng-binding">。。</pre>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>








                        </div>
                    </div>
                </div>
                <div class="box_ft ng-scope">
                    <div class="toolbar" id="tool_bar">
                        <a class="web_wechat_face" href="javascript:;" title="表情"></a>
                        <a class="web_wechat_screencut ng-isolate-scope" href="javascript:;" title="截屏"></a>

                    </div>
                    <div class="content ng-isolate-scope">
                        <pre id="txtPrivateMessage" class="flex edit_area ng-isolate-scope ng-pristine ng-valid" contenteditable="true"></pre>
                        <span class="caret_pos_helper" id="caretPosHelper"></span>
                    </div>
                    <div class="action">
                        <!-- ngIf: !isMacOS --><span ng-if="!isMacOS" class="desc ng-scope">按下Ctrl+Enter换行</span><!-- end ngIf: !isMacOS -->
                        <!-- ngIf: isMacOS -->
                        <a class="btn btn_send" href="javascript:;" ng-click="sendTextMessage()">发送</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal"></div>



</body>
</html>
