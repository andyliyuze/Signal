<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="../Scripts/bootstrap.min.css" rel="stylesheet" />
    <link href="../Css/Chat.css" rel="stylesheet" />
    <link href="Css/group.css" rel="stylesheet" />
    <script src="../Scripts/jquery-2.0.0.min.js"></script>
    <script src="../Scripts/bootstrap.min.js"></script>

    <script src="Scripts/avartar/jquery.cropit.js"></script>

    <script src="Scripts/chat/status.js"></script>
    <script src="Scripts/chat/common.js"></script>
    <script src="Scripts/chat/chatHelper.js"></script>
    <script src="Scripts/chat/userHelper.js"></script>
    <script src="Scripts/chat/chatclient.js"></script>
    <script src="Scripts/chat/userclient.js"></script>

    <script src="Scripts/chat/groupHelper.js"></script>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <!--Reference the SignalR library. -->
    <script src="../Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/js"></script>
    <style>
        .cropit-preview {
            background-color: #f8f8f8;
            background-size: cover;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-top: 7px;
            width: 250px;
            height: 250px;
        }

        .cropit-preview-image-container {
            cursor: move;
        }

        .image-size-label {
            margin-top: 10px;
        }

        input, .export {
            display: block;
        }

        button {
            margin-top: 10px;
        }
    </style>

    <script type="text/javascript">
        var userHub = $.connection.userHub;
        var chatHub = $.connection.chatHub;
        $(function () {
            setScreen(false);
            //      Declare a proxy to reference the hub.

            registerClientMethodsForChat(chatHub);
            registerClientMethodsForUser(userHub);
            // Start Hub
            $.connection.hub.start().done(function () {
                //  registerStartChatEvents(chatHub);
                console.log("连接完成");
                registerEvents(chatHub, userHub);

            });
            $.connection.hub.disconnected(function () {
                console.log("正在尝试重新连接");
                setTimeout(function () {
                    $.connection.hub.start().done(function () {
                        console.log("连接完成");
                        registerEvents(chatHub, userHub);
                    });
                }, 5000); // Restart connection after 5 seconds.
            });
        });

        function setScreen(isLogin) {
            if (!isLogin) {
                $("#divChat").hide();
                $("#divLogin").show();
            }
            else {
                $("#divChat").show();
                $("#divLogin").hide();
            }
        }


        function registerEvents(chatHub, userHub) {

            $("#btnStartChat").click(function () {
                var name = $("#txtNickName").val();
                var pwd = $("#pwd").val().trim();
                if (name.length > 0 && pwd.length > 0) {
                    chatHub.server.connect(name, pwd);
                }
                else {
                    alert("用户名或密码不能为空");
                }
            });

            //群发消息
            $('#btnSendMsg').click(function () {

                var msg = $("#txtMessage").val();
                if (msg.length > 0) {

                    var userName = $('#hdUserName').val();
                    chatHub.server.sendMessageToAll(userName, msg);
                    $("#txtMessage").val('');
                }
            });


            $("#txtNickName").keypress(function (e) {
                if (e.which == 13) {
                    $("#btnStartChat").click();
                }
            });

            $("#txtMessage").keypress(function (e) {
                if (e.which == 13) {
                    $('#btnSendMsg').click();
                }
            });
            // Send Button event
            //私信消息
            $(".btn_send").click(function () {
                var RecevierId = $("#currentUserName").attr("data-uid");
                var msg = $("#txtPrivateMessage").text();
                var SenderName = $("#hdUserName").text();
                var SenderId = $("#hdUserName").attr("data-uid").trim();

                var ChatingId = $("#currentUserName").attr("data-uid").trim();
                var IsChating = SenderId == ChatingId;
                var message = new Object();
                message.SenderId = SenderId;
                message.SenderName = SenderName;
                message.RecevierId = RecevierId;
                message.content = msg;
                var time = new Date();
                message.CreateTime = time;
                if (msg.length > 0) {
                    $("#txtPrivateMessage").text("");
                    //将消息push进Storage，本地存储
                    var key = "MessageListWith_" + message.RecevierId;
                    PushSeesionStorage(key, message);
                    //将消息绑定要页面显示，前端
                    AddMessage(message);
                    //好友列表出也要绑定最新消息以及时间
                    $("#ul_item_" + RecevierId + "").find(".ext:eq(0)").text(getTime(message.CreateTime));
                    $("#ul_item_" + RecevierId + "").find(".chat_item_info p.msg").find("span:eq(0)").text(message.content);
                    //将消息发送到后台处理
                    chatHub.server.sendPrivateMessage(message);


                }
                else { alert("不能发送空消息"); return; }
            });

            //点击查看好友申请的item
            $(document).on('click', '.apply_ul_item', function (e) {
                var Applys = GetSeesionStorageList("FriendsApplys");
                var GroupApplys = GetSeesionStorageList("GroupApplys");
                $(".list-group.friendsApply li").remove();
                $(".list-group.groupApply li").remove();
                if ($("#friendsapplyModal").length <= 0) {

                    $("#modal").load("/User/_FriensApplysPage", function (response, status, xhr) {
                        bindingApplys(Applys);
                        bindingGroupApplys(GroupApplys);
                        $("#friendsapplyModal").modal('show');
                    });
                }
                else {
                    bindingApplys(Applys);
                    bindingGroupApplys(GroupApplys);
                    $("#friendsapplyModal").modal('show');

                }


            });

            //点击查看添加好友回复
            $(document).on('click', '.reply_ul_item', function (e) {

                var Replys = GetSeesionStorageList("FriendReplys");
                //去除好点标识
                $(this).find("i.icon").removeClass("web_wechat_reddot");
                $(".list-group.friendsReply li").remove();
                if ($("#friendsreplyModal").length <= 0) {

                    $("#modal").load("/User/_ReplyResultPage", function (response, status, xhr) {
                    bindingReplys(Replys);
                        $("#friendsreplyModal").modal('show');
                    });
                }
                else {
                    bindingReplys(Replys);
                    $("#friendsreplyModal").modal('show');

                }
                //更新Stroage以及数据库中未读消息
                UpdateUnreadFriendsApply(Replys);
            });

         

            //点击用户时绑定用户名和id
            $(document).on('click', '.friends_item', function () {
                if (IsCurrentUserOrNotUser(this)) { return; }
                //获取当前用户用户名
                var username = $(this).find(".nickname_text").text();
                //更改聊天窗口的用户名
                $("#currentUserName").text(username);
                //获取当前聊天用户的Id
                var id = $(this).attr("data-uid");
                //更改聊天窗口的用户Id
                $("#currentUserName").attr("data-uid", id);
                //清空聊天对话框的消息
                $(".message_ul .message_item ").remove();
                if ($(this).hasClass("NeedGetMsgFromBack")) {
                    //清楚需要从后台获取数据的标识
                    $(this).removeClass("NeedGetMsgFromBack");
                    //
                    var MsgId = $(this).attr("data-unreadMsgId");
                    //如果存在未读消息，则从去后台获取未读消息数据
                    var unreadcount = $(this).attr("data-unreadcount");
                    //  unreadcount = getNum(unreadcount);
                    if (unreadcount > 0) {
                        chatHub.server.getUnreadMsg(id, MsgId, unreadcount).done(function () {
                            //将浏览器的本地缓存消息加载到聊天窗口中
                            GetStrogeMessage(id);

                        });
                    }
                }
                else {
                    //将浏览器的本地缓存消息加载到聊天窗口中
                    GetStrogeMessage(id);
                }


            

                //让未读标志的红点消失
                $(this).find("i.icon").removeClass("web_wechat_reddot");
                //让未读条数变为0，前端
                $("#ul_item_" + id + "").find(".chat_item_info p.msg span.unreadcount").remove();


            });
            //点击+号弹出搜索弹框
            $("#AddUser").click(function () {

                if ($("#myModal").length <= 0) {
                    $("#modal").load("/User/_SearchUserPage", function (response, status, xhr) {
                        $("#myModal").modal('show');

                    });
                }
                else {

                    $("#myModal").modal('show');
                }

                $(".searchresult_info").hide();
                $("#searchVal").val("");
            });
            //searchBtn
            $(document).on('click', "#searchBtn", function () {
                var name = $("#searchVal").val();
                var type = $(".search_type").attr("data-type");
                userHub.server.searchUser(name,type);
            });

            $(document).on('click', "#sendreply", function () {
                //确定申请的类型，好友还是群
                var type = $("#searchresult_uid").attr("data-type");
                var applyUid = $("#hdUserName").attr("data-uid");
                //被申请的主键Id，可能是群Id或者好友Id
                var recevieUid = $("#searchresult_uid").val();
               if (type == "User") {
                   if (applyUid == recevieUid) { alert("不能添加自己为好友!"); return; }
                   userHub.server.sendAddFriendsReply(applyUid, recevieUid);
               }
               else
               {

                   userHub.server.sendAdGroupReply(applyUid, recevieUid);
               }
            });

            //通过申请按钮
            $(document).on('click', '.reply-pass.friend', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
                //更新一下自己的好友列表
                AddUser(ReplyModel.ApplyUid, ReplyModel.ReplyName, ReplyModel.Avatar, ReplyModel.IsOnline);
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已同意", "FriendsApplys");
                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已同意");
                $(this).parent().find("button").remove();
                //更新一下数据库
                userHub.server.beFriend(ReplyModel.ReceiverUserId, ReplyModel.ApplyUid, ReplyModel.ApplyId);
            });

            $(document).on('click', '.reply-refuse.friend', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已拒绝", "FriendsApplys");
                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已拒绝");
                $(this).parent().find("button").remove();
                //更新一下数据库
                userHub.server.refuseApply(ReplyModel.ReceiverUserId, ReplyModel.ApplyId, ReplyModel.ApplyId);
            });
            //tab切换
            $(".tab .tab_item").click(function () {
                $(".pannel .item").addClass("hide");
                var type = $(this).attr("data-type");
                $(".tab .tab_item .web_wechat_tab_chat").css("background-position", "0 -2049px");
                $(".tab .tab_item .web_wechat_tab_public").css("background-position", "0 -2232px");
                $(".tab .tab_item .web_wechat_tab_friends").css("background-position", "0 -2140px");
                if (type == "chat") {
                    $(".pannel .item.chat_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_chat").css("background-position", "0 -2085px");
                    return;
                }
                if (type == "friends") {
                    $(".pannel .item.friends_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_public").css("background-position", "0 -2267px");
                    return;
                }
                if (type == "gruops") {
                    $(".pannel .item.groups_ul").removeClass("hide");
                    $(".tab .tab_item .web_wechat_tab_friends").css("background-position", "0 -2175px");
                    return;
                }
            });
        
            $(document).on('click', "#ul_item_createGroup", function () {
                $("#modal").load("/Group/_CreateGroupPage", function (response, status, xhr) {
                    $("#CreateGroupModal").modal('show');
                    $('.image-editor').cropit();
                    $('.export').click(function () {
                        var imageData = $('.image-editor').cropit('export');
                        $("#img-data").val(data);
                    });
                });
            });

            $(document).on('click', "#createGroup", function () {
                var groupname=$("#setgroupName").val();
                var imageData = $('.image-editor').cropit('export');
                var uid = $("#hdUserName").attr("data-uid");
                imageData = imageData.replace("data:image/png;base64,", "");
                $.ajax({
                    type: 'post',
                    url: '/Group/CreateGruop',
                    data: { GroupName: groupname, Avatar: imageData, UserId: uid },                 
                    success: function (data) {
                        if (data.result == true) {
                            alert("创建成功");
                            AddGroup(data.groupId, data.groupName, data.groupAvatar);
                            $("#CreateGroupModal").modal('hide');
                        }
                        else {
                            alert("创建失败");
                        }
                    },                  
                    error: function () { alert("系统出错"); }
                })
            });
            
            $(document).on('click', ".dropdown-menu.search_type_ul li a", function ()
            {
                var arr = $(".search_type").html().split('<span class="caret"></span>');
                var text = arr[0];
                text = $(this).text();
                $(".search_type").attr("data-type", text);
                $(".search_type").html(text+"<span class=caret></span>");
            });








            //通过入群申请按钮
            $(document).on('click', '.reply-pass.group', function () {
                //根据鼠标点击结果获取reply数据
                var ReplyModel = createReplyModel(this);
              
                //更新一下Storage，该条申请消息的状态为已通过
                UpdateItemById(ReplyModel.ApplyId, "已同意", "GroupApplys");
                //跟新一下消息界面，将选择按钮改为“同意”
                $(this).parent().text("已同意");
                $(this).parent().find("button").remove();
                //更新一下数据库,此时ReceiverUserId代表组Id
                userHub.server.beGroupMember(ReplyModel.ReceiverUserId, ReplyModel.ApplyUid, ReplyModel.ApplyId);
            });



        }

    </script>


    <script>
        //监听模态框关闭事件
        $(document).on('.modal', 'hide.bs.modal', function () {
            // 执行一些动作...
            $("#modal").children().remove();
        })
        //清除
        $(function () {
            sessionStorage.clear();

        });
    </script>


</head>
<body>
    <div class="main" id="divChat">
    
        <div class="pannel">
            <div class="header" style="position: relative; height: 76px; width: 100%;">
                <div class="avatar">

                    <img id="myheadsrc" style="width: 100%;" src="Images/webwxgeticon.jpg" data-uid="" />
                </div>

                <div class="info">
                    <span style="color: #fff;" data-uid="" id="hdUserName"></span>
                    <a style="margin-left: 100px;">
                        <i class="web_wechat_add"></i>
                        <i class="web_wechat_addUser" id="AddUser"></i>
                    </a>
                </div>
            </div>
            <div class="search_bar">
                <i class="web_wechat_search"></i>
                <input class="frm_search ng-isolate-scope ng-pristine ng-valid" type="text" placeholder="搜索">
            </div>
            <div class="tab">
                <div class="tab_item" data-type="chat">
                    <a class="chat" title="聊天" href="#">
                        <i class="web_wechat_tab_chat web_wechat_tab_chat_hl"></i>
                    </a>
                </div>
                <div class="tab_item " data-type="friends">
                    <a class="chat" title="阅读" href="#">
                        <i class="web_wechat_tab_public"></i>
                    </a>
                </div>
                <div class="tab_item" data-type="gruops">
                    <a class="chat" title="通讯录" href="#">
                        <i class="web_wechat_tab_friends"></i>
                    </a>
                </div>
            </div>
            <div class="item chat_ul">
                <div class="chat_ul_div">
                    


                </div>
            </div>
            <div class="item friends_ul hide">

            </div>
            <div class="item groups_ul hide">
                <div class="chat_ul_div">

                    <div data-uid="a401ff37-857f-4816-b981-b91419f37726" class="chat_ul_item" id="ul_item_createGroup">
                   
                    <div class="avatar">
                        <img class="img" id="img_a401ff37-857f-4816-b981-b91419f37726" src="/Content/upload/image/HeadImage/20170210172536.Jpeg">
                        <i class="icon ng-scope"></i>
                         </div>
                    <div class="chat_item_info">
                        <h3 class="nickname">
                        <span class="nickname_text ng-binding" style="margin-top: 10px;  font-size: 15px; color: #56b5ad;">创建群</span>      
                        </h3>
                    </div>
                    </div>

                </div>
            </div>







        </div>
        <div class="right chat">
            <div class="panel panel-default" style="background-color: #eee;">
                <div id="currentUserName" data-uid="" class="panel-heading" style="text-align: center;">
                    Panel heading without title
                    <i class="web_wechat_down_icon"></i>
                </div>
                <div class="panel-body" style="padding-bottom: 0; height: 377px; overflow: auto;">
                    <div class="ng-scope">
                        <div class="message_ul">
                            <div class="message_item message" style=" margin-bottom 16px; float left; width 100%;">
                                <p class="message_system ng-scope">
                                    <span class="content ng-binding">9:52</span>
                                </p>

                                <img class="avatar" src="Images/webwxgeticon%20(1).jpg" title="李思晓" />
                                <div class="content">

                                    <div class="bubble js_message_bubble ng-scope bubble_default left">
                                        <div class="bubble_cont ng-scope">
                                            <div class="plain">
                                                <pre class="js_message_plain ng-binding">。。</pre>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>








                        </div>
                    </div>
                </div>
                <div class="box_ft ng-scope">
                    <div class="toolbar" id="tool_bar">
                        <a class="web_wechat_face" href="javascript:;" title="表情"></a>
                        <a class="web_wechat_screencut ng-isolate-scope" href="javascript:;" title="截屏"></a>

                    </div>
                    <div class="content ng-isolate-scope">
                        <pre id="txtPrivateMessage" class="flex edit_area ng-isolate-scope ng-pristine ng-valid" contenteditable="true"></pre>
                        <span class="caret_pos_helper" id="caretPosHelper"></span>
                    </div>
                    <div class="action">
                        <!-- ngIf: !isMacOS --><span ng-if="!isMacOS" class="desc ng-scope">按下Ctrl+Enter换行</span><!-- end ngIf: !isMacOS -->
                        <!-- ngIf: isMacOS -->
                        <a class="btn btn_send" href="javascript:;" ng-click="sendTextMessage()">发送</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="divLogin" class="login" style="margin: auto; width: 200px; margin-top: 100px;">
        <div>
            用户名:<br />
            <input id="txtNickName" type="text" class="textBox" />
        </div>
        <div>
            密码:<br />
            <input id="pwd" type="text" class="textBox" />
        </div>
        <div id="divButton">
            <input id="btnStartChat" type="button" class="submitButton" value="登录" />
        </div>
    </div>
    <div id="modal"></div>

     

</body>
</html>
